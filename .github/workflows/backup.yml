name: Supabase Backup

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  backup:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # –ù—É–∂–Ω–æ –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –±—ç–∫–∞–ø–æ–≤
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Create backups directory
        run: mkdir -p backups
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Backup database
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          BACKUP_FILE="backups/supabase_backup_${TIMESTAMP}.sql"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ URL..."
          echo "URL (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤): ${SUPABASE_DB_URL:0:50}..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π URL - pg_dump —Å–∞–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–∞—Ä—Å–∏—Ç –µ–≥–æ
          echo "üîÑ –ó–∞–ø—É—Å–∫ pg_dump —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π URL..."
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏—è IPv4
          # –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å IPv6
          export PGHOSTADDR=""
          
          # –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π URL
          pg_dump "$SUPABASE_DB_URL" \
            --no-owner \
            --no-acl \
            --clean \
            --if-exists \
            --verbose \
            -f "$BACKUP_FILE" 2>&1 | tee backup.log || DUMP_ERROR=$?
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ -n "$DUMP_ERROR" ] || [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
            echo "‚ùå –ü—Ä—è–º–æ–π URL –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª"
            echo "üìÑ –õ–æ–≥–∏ –æ—à–∏–±–∫–∏:"
            cat backup.log
            echo ""
            echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
            echo ""
            echo "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 'Tenant or user not found':"
            echo "  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è –≤ SUPABASE_DB_URL"
            echo "  - –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω: \$ ‚Üí %24, @ ‚Üí %40"
            echo ""
            echo "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 'Network is unreachable':"
            echo "  - Connection Pooling –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –ø–ª–∞–Ω–µ"
            echo "  - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–∫—Ä–µ—Ç SUPABASE_DB_URL –≤ GitHub:"
            echo "  Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí SUPABASE_DB_URL"
            echo ""
            echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:"
            echo "  –î–ª—è Connection Pooling:"
            echo "    postgresql://postgres.orrkwxgfoafyenudouqh:Kraba%24et%40Supabase@aws-0-eu-central-1.pooler.supabase.com:6543/postgres"
            echo ""
            echo "  –î–ª—è –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–µ—Å–ª–∏ pooling –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):"
            echo "    postgresql://postgres:Kraba%24et%40Supabase@db.orrkwxgfoafyenudouqh.supabase.co:5432/postgres"
            exit 1
          fi
          
          # –°–∂–∏–º–∞–µ–º –±—ç–∫–∞–ø
          gzip "$BACKUP_FILE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Å–∂–∞—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
          BACKUP_SIZE=$(stat -f%z "${BACKUP_FILE}.gz" 2>/dev/null || stat -c%s "${BACKUP_FILE}.gz" 2>/dev/null || echo "0")
          echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${BACKUP_FILE}.gz (—Ä–∞–∑–º–µ—Ä: ${BACKUP_SIZE} –±–∞–π—Ç)"
      
      - name: Clean old backups (keep last 30)
        run: |
          cd backups
          if [ -n "$(ls -A *.sql.gz 2>/dev/null)" ]; then
            ls -t *.sql.gz | tail -n +31 | xargs -r rm -f || true
            echo "üßπ –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —É–¥–∞–ª–µ–Ω—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30)"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –±—ç–∫–∞–ø–æ–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏"
          fi
      
      - name: Commit and push backups
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add backups/
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            git commit -m "Auto backup: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git remote -v
            git push origin main
            echo "‚úÖ –ë—ç–∫–∞–ø –∑–∞–∫–æ–º–º–∏—á–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
          fi

