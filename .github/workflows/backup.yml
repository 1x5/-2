name: Supabase Backup

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  backup:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # –ù—É–∂–Ω–æ –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –±—ç–∫–∞–ø–æ–≤
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Create backups directory
        run: mkdir -p backups
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Backup database
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          BACKUP_FILE="backups/supabase_backup_${TIMESTAMP}.sql"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ URL..."
          echo "URL (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤): ${SUPABASE_DB_URL:0:50}..."
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ
          # –§–æ—Ä–º–∞—Ç: postgresql://user:pass@host:port/db
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ GitHub Actions)
          echo "üîç –ü–∞—Ä—Å–∏–Ω–≥ URL —á–µ—Ä–µ–∑ Python..."
          
          PYTHON_PARSE=$(python3 << 'EOF'
import sys
from urllib.parse import urlparse, unquote

url = sys.argv[1]
parsed = urlparse(url)

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
username = parsed.username or ""
password = parsed.password or ""
hostname = parsed.hostname or ""
port = parsed.port or ""
path = parsed.path.lstrip('/') or "postgres"

print(f"USER:{username}")
print(f"PASS:{password}")
print(f"HOST:{hostname}")
print(f"PORT:{port}")
print(f"DB:{path}")
EOF
"$SUPABASE_DB_URL" 2>/dev/null)
          
          if [ -n "$PYTHON_PARSE" ]; then
            DB_USER=$(echo "$PYTHON_PARSE" | grep "^USER:" | cut -d: -f2-)
            DB_PASS=$(echo "$PYTHON_PARSE" | grep "^PASS:" | cut -d: -f2-)
            DB_HOST=$(echo "$PYTHON_PARSE" | grep "^HOST:" | cut -d: -f2-)
            DB_PORT=$(echo "$PYTHON_PARSE" | grep "^PORT:" | cut -d: -f2-)
            DB_NAME=$(echo "$PYTHON_PARSE" | grep "^DB:" | cut -d: -f2-)
          else
            echo "‚ö†Ô∏è Python –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback..."
            # Fallback: –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥
            DB_URL_NO_PROTOCOL="${SUPABASE_DB_URL#postgresql://}"
            DB_USER_PASS="${DB_URL_NO_PROTOCOL%%@*}"
            DB_HOST_PORT_DB="${DB_URL_NO_PROTOCOL#*@}"
            
            DB_USER="${DB_USER_PASS%%:*}"
            DB_PASS="${DB_USER_PASS#*:}"
            
            # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–≤–æ–µ—Ç–æ—á–∏–µ –ø–µ—Ä–µ–¥ —Å–ª—ç—à–µ–º (—ç—Ç–æ –ø–æ—Ä—Ç)
            DB_HOST_PORT_DB_NO_SLASH="${DB_HOST_PORT_DB%%/*}"
            DB_PORT="${DB_HOST_PORT_DB_NO_SLASH##*:}"
            DB_HOST="${DB_HOST_PORT_DB_NO_SLASH%:*}"
            DB_NAME="${DB_HOST_PORT_DB#*/}"
          fi
          
          # –î–µ–∫–æ–¥–∏—Ä—É–µ–º URL-encoded –ø–∞—Ä–æ–ª—å
          DB_PASS_DECODED=$(echo -n "$DB_PASS" | sed 's/%24/$/g' | sed 's/%40/@/g' | sed 's/%3A/:/g' | sed 's/%2F/\//g')
          
          echo "üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
          echo "  Host: $DB_HOST"
          echo "  Port: $DB_PORT"
          echo "  User: $DB_USER"
          echo "  Database: $DB_NAME"
          
          # –ü–æ–ª—É—á–∞–µ–º IPv4 –∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞ –¥–ª—è —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏—è IPv4
          echo "üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IPv4 –∞–¥—Ä–µ—Å–∞..."
          DB_HOST_IPV4=$(getent hosts "$DB_HOST" | awk '{ print $1 }' | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' | head -1)
          
          if [ -z "$DB_HOST_IPV4" ]; then
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IPv4 –∞–¥—Ä–µ—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ö–æ—Å—Ç –ø–æ –∏–º–µ–Ω–∏"
            DB_HOST_TO_USE="$DB_HOST"
          else
            echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º IPv4 –∞–¥—Ä–µ—Å: $DB_HOST_IPV4"
            DB_HOST_TO_USE="$DB_HOST_IPV4"
          fi
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PGPASSWORD
          export PGPASSWORD="$DB_PASS_DECODED"
          
          # –§–æ—Ä—Å–∏—Ä—É–µ–º IPv4 —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PGSSLMODE –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ IP
          # –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IPv4 –Ω–∞–ø—Ä—è–º—É—é
          echo "üîÑ –ó–∞–ø—É—Å–∫ pg_dump —Å IPv4..."
          pg_dump \
            --host="$DB_HOST_TO_USE" \
            --port="$DB_PORT" \
            --username="$DB_USER" \
            --dbname="$DB_NAME" \
            --no-owner \
            --no-acl \
            --clean \
            --if-exists \
            --verbose \
            -f "$BACKUP_FILE" 2>&1 | tee backup.log || DUMP_ERROR=$?
          
          unset PGPASSWORD
          
          # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π URL —Å IPv4
          if [ -n "$DUMP_ERROR" ] || [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
            echo "‚ùå –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ Connection Pooling..."
            
            # –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ø—Ä–æ–±—É–µ–º Connection Pooling
            if [[ "$DB_HOST" == db.* ]]; then
              # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Connection Pooling —Ñ–æ—Ä–º–∞—Ç
              PROJECT_REF="${DB_HOST#db.}"
              PROJECT_REF="${PROJECT_REF%%.supabase.co}"
              
              POOLER_URL="postgresql://postgres.${PROJECT_REF}:${DB_PASS}@aws-0-eu-central-1.pooler.supabase.com:6543/${DB_NAME}"
              
              echo "üîÑ –ü—Ä–æ–±—É–µ–º Connection Pooling: postgresql://postgres.${PROJECT_REF}:***@aws-0-eu-central-1.pooler.supabase.com:6543/${DB_NAME}"
              
              export PGPASSWORD="$DB_PASS_DECODED"
              
              pg_dump "$POOLER_URL" \
                --no-owner \
                --no-acl \
                --clean \
                --if-exists \
                --verbose \
                -f "$BACKUP_FILE" 2>&1 | tee -a backup.log || true
              
              unset PGPASSWORD
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –±—ç–∫–∞–ø –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π"
            echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
            tail -30 backup.log || true
            echo ""
            echo "üí° –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ IPv4/IPv6"
            echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Connection Pooling URL –≤ —Å–µ–∫—Ä–µ—Ç–µ:"
            echo "   postgresql://postgres.orrkwxgfoafyenudouqh:Kraba%24et%40Supabase@aws-0-eu-central-1.pooler.supabase.com:6543/postgres"
            exit 1
          fi
          
          # –°–∂–∏–º–∞–µ–º –±—ç–∫–∞–ø
          gzip "$BACKUP_FILE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Å–∂–∞—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
          BACKUP_SIZE=$(stat -f%z "${BACKUP_FILE}.gz" 2>/dev/null || stat -c%s "${BACKUP_FILE}.gz" 2>/dev/null || echo "0")
          echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${BACKUP_FILE}.gz (—Ä–∞–∑–º–µ—Ä: ${BACKUP_SIZE} –±–∞–π—Ç)"
      
      - name: Clean old backups (keep last 30)
        run: |
          cd backups
          if [ -n "$(ls -A *.sql.gz 2>/dev/null)" ]; then
            ls -t *.sql.gz | tail -n +31 | xargs -r rm -f || true
            echo "üßπ –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —É–¥–∞–ª–µ–Ω—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30)"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –±—ç–∫–∞–ø–æ–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏"
          fi
      
      - name: Commit and push backups
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add backups/
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            git commit -m "Auto backup: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git remote -v
            git push origin main
            echo "‚úÖ –ë—ç–∫–∞–ø –∑–∞–∫–æ–º–º–∏—á–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
          fi

